<template>
   <div class="home-container my-type-center px-2">

      <a-carousel effect="fade" autoplay class="transition-all">
         <!-- ‰∏ªÂäüËÉΩÊ®°Âºè‰ªãÁªçËΩÆÊí≠ -->
         <div v-for="(item, index) in carouselData" :key="index"
            class="manBox h-[250px] transition-all relative rounded-xl overflow-hidden">
            <!-- ËÉåÊôØÊ®°Á≥ä -->
            <div class="absolute size-full my-bg-gradient">
               <img class="w-[400px] absolute top-1/2 -translate-y-1/2 -right-10 blur-lg rotate-45" :src="item.img">
            </div>
            <!-- ÂõæÊ†áÂ±ïÁ§∫ -->
            <div :style="`background-image: url(${getAssetsImg(item.img)});`"
               class="absolute size-[200px] top-1/2 -translate-y-1/2 md:left-10 left-2 bg-cover">
               <!-- <img class="absolute bottom-0 left-1/2 -translate-x-1/2" :src="item.img"> -->
            </div>
            <!-- ÊñáÂ≠ó‰ªãÁªç -->
            <div
               class="absolute top-1/2 -translate-y-1/2 right-2 md:right-10 w-[180px] transition-all md:w-auto text-base-content/100">
               <h1 class="md:text-2xl text-xl font-bold">{{ item.title }}</h1>
               <p class="md:text-lg text-md">{{ item.desc }}</p>
            </div>
         </div>
      </a-carousel>

      <!-- Âø´Êç∑ÂÖ•Âè£ -->
      <div class="flex gap-3 my-10 flex-wrap justify-center sm:justify-start">
         <!-- ‰∏™‰∫∫‰∏≠ÂøÉ -->
         <button @click="$router.push('/user')" class="btn btn-primary">
            <IconFont type="icon-yonghu" class="text-lg" />
            ‰∏™‰∫∫‰∏≠ÂøÉ
         </button>
         <!-- Áè≠Á∫ß -->
         <button @click="myClassBtnHandler" class="btn btn-secondary">
            <IconFont type="icon-banjixinxi" class="text-xl" />
            ÊàëÁöÑÁè≠Á∫ß
         </button>
         <!-- Âú®Á∫ø‰∫§ÊµÅ -->
         <button @click="socketStore.chatWindowShow = true" class="btn btn-success">
            <IconFont type="icon-xiaoxi" class="text-xl" />
            ËÅäÂ§©Ê∂àÊÅØ
         </button>
         <!-- ÂêéÂè∞ÁÆ°ÁêÜ -->
         <button v-show="!isNormalUser" @click="adminBtnHandler" class="btn btn-warning">
            <IconFont type="icon-houtaiguanli-houtaiguanli" class="text-xl" />
            ÂêéÂè∞ÁÆ°ÁêÜ
         </button>
      </div>

      <!-- ÂàÜÂâ≤Á∫ø -->
      <template v-if="userStore.userInfo">
         <div class="divider divider-start font-bold">ËøëÊúüÂ≠¶‰π†</div>
         <!-- ËøëÊúüÂ≠¶‰π†ÁöÑËØçÈõÜÂàóË°® h-[calc((200px*2)+10px)] overflow-y-auto -->
         <div v-if="vocStudyList.length"
            class="recent w-full transition-all h-[calc((200px+0.8rem)*4)] md:h-[calc((200px+0.8rem)*2)] min-[1600px]:h-[calc((200px+0.8rem)*1)]">
            <a-row :gutter="[10, 10]">
               <a-col :xs="24" :md="12" :xl="8" :xxl="6" v-for="(voc, i) in vocStudyList" :key="i">
                  <div class="cardT z-10 rounded-lg text-gray-200" @click="$router.push('/vocabulary/' + voc.id)">
                     <p>{{ voc.title }}</p>
                     <p>{{ voc.count }} ‰∏™ËØçÊù°</p>
                     <!-- Âè≥‰∏ãËßí Êó∂Èó¥ -->
                     <span>{{ dayjs(voc.updateTime).format('YYYY-MM-DD') }}</span>
                     <div class="userd">
                        <!-- Â§¥ÂÉè -->
                        <div class="avatar">
                           <div class="w-8 rounded-full">
                              <img :src="voc.author?.avatar" />
                           </div>
                        </div>
                        <!-- Áî®Êà∑Âêç -->
                        <span class="font-bold">{{ voc.author?.username }}</span>
                     </div>
                  </div>
                  <div
                     class="absolute top-0 right-1 w-[calc(100%-10px)] h-full flex items-center rounded-lg overflow-hidden">
                     <img :src="voc.cover" class="blur-[5px]">
                  </div>
               </a-col>
            </a-row>
         </div>
         <div v-else class="text-center text-gray-500 py-5">ÊöÇÊó†Êï∞ÊçÆ</div>
      </template>

      <!-- ÁÉ≠Èó®ËØçÈõÜÂíåÊ¥ªË∑ÉËÄÖ -->
      <div class="min-h-[200px] mt-8">
         <div class="flex flex-col lg:flex-row justify-between gap-6">
            <!-- ÁÉ≠Èó®ËØçÈõÜ -->
            <div class="w-full lg:w-1/2">
               <div class="flex items-center gap-2 mb-4">
                  <IconFont type="icon-icon_huore" class="text-xl text-blue-500" />
                  <h2
                     class="text-xl font-bold bg-gradient-to-r from-blue-500 to-cyan-500 bg-clip-text text-transparent">
                     ÁÉ≠Èó®ËØçÈõÜ
                  </h2>
               </div>

               <div v-if="mostStudyVocList.length" class="space-y-3">
                  <div v-for="(voc, index) in mostStudyVocList" :key="index"
                     @click="$router.push('/vocabulary/' + voc.id)"
                     class="group relative bg-gradient-to-r from-base-200 to-base-100 hover:from-blue-50 hover:to-cyan-50 dark:hover:from-blue-900/20 dark:hover:to-cyan-900/20 p-4 rounded-xl border border-base-300 hover:border-blue-200 dark:hover:border-blue-800 cursor-pointer transition-all duration-300 hover:shadow-lg hover:scale-[1.02] overflow-hidden">

                     <!-- ÊéíÂêçÊ†áËØÜ -->
                     <!-- <div class="absolute -top-2 -left-2 w-8 h-8 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center text-white text-sm font-bold shadow-lg">
                        {{ index + 1 }}
                     </div> -->

                     <!-- ÁÉ≠Èó®Ê†áËØÜ (Ââç‰∏âÂêç) -->
                     <!-- <div v-if="index < 3" class="absolute top-2 right-2">
                        <div class="flex items-center gap-1 bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-2 py-1 rounded-full text-xs font-bold">
                           <IconFont type="icon-icon_huore" class="text-xs" />
                           <span v-if="index === 0">üî•ÁÉ≠</span>
                           <span v-else-if="index === 1">üíé‰ºò</span>
                           <span v-else>‚≠êËµû</span>
                        </div>
                     </div> -->

                     <div class="flex items-center justify-between">
                        
                     <!-- ÊéíÂêçÊï∞Â≠ó -->
                     <div class="flex-shrink-0 mr-3">
                        <div
                           class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg">
                           {{ index + 1 }}
                        </div>
                     </div>

                        <div class="flex-1 min-w-0">
                           <!-- Ê†áÈ¢ò -->
                           <h3
                              class="font-bold text-base text-base-content group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors duration-300 truncate mb-2">
                              {{ voc.title }}
                           </h3>

                           <!-- ‰ΩúËÄÖ‰ø°ÊÅØ -->
                           <div class="flex items-center gap-2">
                              <div class="avatar">
                                 <div class="w-6 h-6 rounded-full border-2 border-blue-200 dark:border-blue-800">
                                    <img :src="voc.author?.avatar" class="rounded-full" />
                                 </div>
                              </div>
                              <span
                                 class="text-sm text-base-content/70 group-hover:text-blue-500 transition-colors duration-300">
                                 {{ voc.author?.username }}
                              </span>
                           </div>
                        </div>

                        <!-- Â≠¶‰π†Êï∞ÊçÆ -->
                        <div class="text-right ml-4">
                           <div class="bg-gradient-to-r text-center from-blue-500 to-cyan-500 bg-clip-text text-transparent">
                              <div class="text-2xl font-bold">{{ voc.stuNum }}</div>
                              <div class="text-xs text-base-content/60">‰∫∫Â≠¶‰π†</div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
               <div v-else class="text-center text-gray-500 py-12 bg-base-200 rounded-xl">
                  <IconFont type="icon-zanwushuju" class="text-4xl mb-2" />
                  <p>ÊöÇÊó†ÁÉ≠Èó®ËØçÈõÜ</p>
               </div>
            </div>

            <!-- Â≠¶Èú∏Ê¶ú -->
            <div class="w-full lg:w-1/2">
               <div class="flex items-center gap-2 mb-4">
                  <IconFont type="icon-paihangbang" class="text-xl text-blue-500" />
                  <h2
                     class="text-xl font-bold bg-gradient-to-r from-blue-500 to-purple-500 bg-clip-text text-transparent">
                     Â≠¶Èú∏Ê¶ú</h2>
               </div>

               <div v-if="mostStudyUserList.length" class="space-y-3">
                  <div v-for="(user, i) in mostStudyUserList" :key="i" @click="$router.push('/user/' + user.id)"
                     class="group relative bg-gradient-to-r from-base-200 to-base-100 hover:from-blue-50 hover:to-purple-50 dark:hover:from-blue-900/20 dark:hover:to-purple-900/20 p-4 rounded-xl border border-base-300 hover:border-blue-200 dark:hover:border-blue-800 cursor-pointer transition-all duration-300 hover:shadow-lg hover:scale-[1.02] overflow-hidden">

                     <!-- ÊéíÂêçËÉåÊôØÊïàÊûú -->
                     <div class="absolute inset-0 opacity-5">
                        <div
                           class="absolute right-0 top-0 text-8xl font-black text-blue-500 transform rotate-12 translate-x-4 -translate-y-4">
                           {{ i + 1 }}
                        </div>
                     </div>

                     <!-- ÊéíÂêçÂ•ñÁâå (Ââç‰∏âÂêç) -->
                     <!-- <div v-if="i < 3" class="absolute -top-1 -right-1">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-lg">
                           <span v-if="i === 0">ü•á</span>
                           <span v-else-if="i === 1">ü•à</span>
                           <span v-else>ü•â</span>
                        </div>
                     </div> -->

                     <div class="relative flex items-center justify-between">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                           <!-- ÊéíÂêçÊï∞Â≠ó
                           <div class="flex-shrink-0">
                              <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg">
                                 {{ i + 1 }}
                              </div>
                           </div> -->

                           <!-- Â§¥ÂÉè -->
                           <div class="avatar flex-shrink-0">
                              <div
                                 class="w-12 h-12 rounded-full border-3 border-blue-200 dark:border-blue-800 group-hover:border-blue-400 transition-colors duration-300">
                                 <img :src="user.avatar" class="rounded-full" />
                              </div>
                           </div>

                           <!-- Áî®Êà∑‰ø°ÊÅØ -->
                           <div class="flex-1 min-w-0">
                              <h3
                                 class="font-bold text-base text-base-content group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors duration-300 truncate">
                                 {{ user.username }}
                              </h3>
                              <div class="flex items-center gap-1 text-sm text-base-content/70">
                                 <IconFont type="icon-xuexi" class="text-xs" />
                                 <span>Â≠¶‰π†‰∫Ü {{ user.studyTotal }} Ê¨°</span>
                              </div>
                           </div>
                        </div>

                        <!-- Â≠¶Èú∏Ê†áËØÜ (Ââç‰∏âÂêç) -->
                        <div v-if="i < 3" class="flex-shrink-0">
                           <div
                              class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-2 py-1 rounded-full text-xs font-bold">
                              <span v-if="i === 0">ü•á‰ºòÁßÄ</span>
                              <span v-else-if="i === 1">ü•àÊù∞Âá∫</span>
                              <span v-else>ü•âÂá∫Ëâ≤</span>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
               <div v-else class="text-center text-gray-500 py-12 bg-base-200 rounded-xl">
                  <IconFont type="icon-zanwushuju" class="text-4xl mb-2" />
                  <p>ÊöÇÊó†Ê¥ªË∑ÉÁî®Êà∑</p>
               </div>
            </div>
         </div>
      </div>
   </div>
</template>

<script setup lang="ts">
import { useUserStore } from "@/stores/userStore";
import { useSocketStore } from "@/stores/socketStore";
import IconFont from "@/utils/iconFont";
import type { Vocabulary } from "@/types/vocabulary";
import { ref } from "vue";
import { VocabularyAPI } from "@/api/vocabulary";
import { message } from "ant-design-vue";
import { UserAPI } from "@/api/user";
import type { User } from "@/types/user";
import { useRoute } from "vue-router";
import router from "@/router";
import { MyUtils } from "@/utils";
import dayjs from "dayjs";

const route = useRoute();
const userStore = useUserStore();
const socketStore = useSocketStore();

// ËΩÆÊí≠Êï∞ÊçÆ
const carouselData = [
   {
      title: "ÂÆûÊó∂‰∫íÂä®‰∫§ÊµÅ",
      desc: "ÈöèÊó∂ÂèëËµ∑ËÆ®ËÆ∫ÔºåÂø´ÈÄüËß£ÂÜ≥Â≠¶‰π†ÈöæÈ¢ò",
      img: "online2.webp",
   },
   {
      title: "Âàõ‰ΩúÂÖ±‰∫´ËØçÈõÜ",
      desc: "‰∏ì‰∏öÁºñËæëÂ∑•ÂÖ∑ÔºåÊâìÈÄ†È´òË¥®ÈáèÂ≠¶‰π†ËµÑÊ∫ê",
      img: "book.webp",
   },
   {
      title: "Êô∫ËÉΩÂ≠¶‰π†Ê®°Âºè",
      desc: "ÁßëÂ≠¶ËÆ∞ÂøÜÁÆóÊ≥ïÔºå‰∏™ÊÄßÂåñÊèêÂçáÂ≠¶‰π†ÊïàÁéá",
      img: "study.webp",
   }
];
// Áî®Êà∑Â≠¶‰π†ÁöÑËØçÈõÜÂàóË°®
const vocStudyList = ref<Vocabulary[]>([]);
// Â≠¶‰π†ÈáèÂâç5ÁöÑËØçÈõÜÂàóË°®
const mostStudyVocList = ref<Vocabulary[]>([]);
// Â≠¶‰π†ÈáèÂâç5ÁöÑÁî®Êà∑ÂàóË°®
const mostStudyUserList = ref<User[]>([]);
// ÊòØÂê¶ÊòØÊôÆÈÄöÁî®Êà∑ (‰∏çÊòØÁÆ°ÁêÜÂëòÂíåËÄÅÂ∏à)
const isNormalUser = ref<boolean>(true);

// Á¨¨‰∏âÊñπÁôªÂΩï(‰∏îÂ∑≤ÁªëÂÆö)
if (route.query.token) {
   getUserInfoByToken()
}
// Âà§Êñ≠ÊòØÂê¶ÁôªÂΩï
if (userStore.userInfo && userStore.userInfo.id) {
   // Ëé∑ÂèñÁî®Êà∑Â≠¶‰π†ÁöÑËØçÈõÜÂàóË°®
   getUserRelevanceVocListByUid();
   // Ëé∑ÂèñÂ≠¶‰π†Êï∞ÈáèÊúÄÂ§öÁöÑËØçÈõÜÂàóË°®
   // getMostStudyVocList(); // ‰∏çÁôªÂΩï‰πüËÉΩÁúãÂà∞
   // Ëé∑ÂèñÂ≠¶‰π†Êï∞Ââç5ÁöÑÁî®Êà∑ÂàóË°®
   // getMostStudyUserList(); // ‰∏çÁôªÂΩï‰πüËÉΩÁúãÂà∞
   // Âà§Êñ≠ÊòØÂê¶ÊòØÊôÆÈÄöÁî®Êà∑
   isNormalUser.value = userStore.userInfo.roleList?.findIndex((item) => item.id == 1 || item.id == 2) == -1;
} else {
   console.log("Êú™ÁôªÂΩï");
}
// Ëé∑ÂèñÂ≠¶‰π†Êï∞ÈáèÊúÄÂ§öÁöÑËØçÈõÜÂàóË°®
getMostStudyVocList();
// Ëé∑ÂèñÂ≠¶‰π†Êï∞Ââç5ÁöÑÁî®Êà∑ÂàóË°®
getMostStudyUserList();

// ÂêéÂè∞ÁÆ°ÁêÜÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
function adminBtnHandler() {
   // MyUtils.alert("ÊöÇÊú™ÂºÄÊîæ", "warning")
   window.open("http://gp-admin.tockey.cn/")
}

// ÊàëÁöÑÁè≠Á∫ßÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
function myClassBtnHandler() {
   // Ê£ÄÊü•ÊòØÂê¶Âä†ÂÖ•‰∫ÜÁè≠Á∫ß
   if (userStore.userInfo?.classes) {
      // Ë∑≥ËΩ¨Âà∞Áè≠Á∫ßÈ°µÈù¢
      router.push('/classes/' + userStore.userInfo?.classes.id)
   } else {
      MyUtils.alert("ÊÇ®ËøòÊ≤°ÊúâÂä†ÂÖ•Áè≠Á∫ß", "warning")
   }

}

// Ëé∑ÂèñÂõæÁâáË∑ØÂæÑ
function getAssetsImg(name: string) {
   let data = new URL(`../../assets/img/${name}`, import.meta.url).href
   console.log(data)
   return data;
}

// ÈÄöËøá token Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
async function getUserInfoByToken() {
   let result = await UserAPI.getUserInfoByToken(route.query.token as string);
   if (result.code == 20000) {
      userStore.setUserInfo(result.data, route.query.token as string);
      // console.log("Áî®Êà∑‰ø°ÊÅØ", result.data);
      // ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢
      location.href = "/";
   }
}

// Ëé∑ÂèñÁî®Êà∑Â≠¶‰π†ÁöÑËØçÈõÜÂàóË°®
async function getUserRelevanceVocListByUid() {
   let result = await VocabularyAPI.getUserRelevanceVocListByUid(userStore.userInfo?.id!);
   if (result.code == 20000) {
      vocStudyList.value = result.data;
      // ÊúÄÂ§öÊòæÁ§∫4‰∏™ËØçÈõÜ
      if (vocStudyList.value.length > 4) {
         vocStudyList.value = vocStudyList.value.slice(0, 4);
      }
      // console.log("vocStudyList", vocStudyList.value);

   } else {
      message.error("Ëé∑ÂèñÁî®Êà∑Â≠¶‰π†ÁöÑËØçÈõÜÂàóË°®Â§±Ë¥•");
   }
}
// Ëé∑ÂèñÂ≠¶‰π†Êï∞ÈáèÊúÄÂ§öÁöÑËØçÈõÜÂàóË°®
async function getMostStudyVocList() {
   let result = await VocabularyAPI.getMostStudyVocList();
   if (result.code == 20000) {
      // mostStudyVocList.value = result.data;
      // ÊúÄÂ§öÊòæÁ§∫5‰∏™ËØçÈõÜ
      if (result.data.length > 5) {
         mostStudyVocList.value = result.data.slice(0, 5);
      } else {
         mostStudyVocList.value = result.data;
      }
   } else {
      message.error(result.message);
   }
}
// Ëé∑ÂèñÂ≠¶‰π†Êï∞Ââç5ÁöÑÁî®Êà∑ÂàóË°®
async function getMostStudyUserList() {
   let result = await UserAPI.getActiveUserList();
   if (result.code == 20000) {
      userStore
      mostStudyUserList.value = result.data;
   } else {
      message.error(result.message);
   }
}
</script>

<style lang="less" scoped>
.home-container {
   .recent {
      padding: 10px 0;
      // height: calc((200px * 2) + 30px);
      // background-color: antiquewhite;
      // overflow: hidden;


      >div {
         height: 200px;

         >div {
            height: 100%;
            transition: all 0.3s ease 0s;

            // border: 1px solid red;
            >.cardT {
               transition: all 0.3s ease 0s;
               background-image: linear-gradient(120deg, #555555 20%, #89f6fe00 120%);
               height: 100%;
               position: relative;
               // ÊÇ¨ÊµÆÂ∞èÊâã
               cursor: pointer;

               // ÊÇ¨ÊµÆÈò¥ÂΩ±
               &:hover {
                  box-shadow: rgba(50, 50, 93, 0.25) 0px 6px 12px -2px, rgba(0, 0, 0, 0.3) 0px 3px 7px -3px;
               }

               >p {
                  position: absolute;

                  // Ê†áÈ¢ò
                  &:nth-child(1) {
                     top: 10px;
                     left: 10px;
                     font-size: 20px;
                     font-weight: 600;
                  }

                  // ËØçÊù°Êï∞Èáè
                  &:nth-child(2) {
                     top: 40px;
                     left: 10px;
                     font-size: 14px;
                  }
               }

               // Êó•Êúü
               >span {
                  position: absolute;
                  bottom: 10px;
                  right: 10px;
                  font-size: 14px;
               }

               // Â§¥ÂÉèÂíåÊòµÁß∞
               >.userd {
                  position: absolute;
                  bottom: 10px;
                  left: 10px;
                  font-size: 14px;
                  display: flex;
                  align-items: center;

                  >span:nth-child(2) {
                     margin-left: 10px;
                  }
               }
            }
         }
      }
   }
}

// ËÉåÊôØÊ∏êÂèò
.my-bg-gradient {
   background-image: linear-gradient(120deg, oklch(var(--b3)) 0%, oklch(var(--p)) 100%);
}
</style>